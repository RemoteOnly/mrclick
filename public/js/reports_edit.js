$(function(){"use strict";function t(){for(var t=1;t<=l;t++){var e=$("#selTextbook"+t),o=e.data("item-id");o&&(e.val(o),e.change(),t>1&&($("#Textbook"+t).show(),$(".minus").prop("disabled",!1)));var a=$("#selUnit"+t),n=a.data("item-id");n&&a.val(n);var s=$("#page"+t);s.val(s.data("item-value"))}}function e(){var t=location.href.split("/"),e=t[3];return e}function o(t,o){$.ajax({type:"GET",url:"/api/"+e()+"/getoldhomeworks?",dataType:"json",data:{subjects:t?t.toString():"",studentid:o},scriptCharset:"utf-8",success:function(t){var e=t.oldHomeworks;$("#homeworksbody tr").remove(),$.each(e,function(){$("#homeworksbody").append("<tr><td>"+this.date+"</td><td>"+this.subjects+'</td><td><span class="js-context">'+this.text+"</span></td></tr>")})}})}function a(t,o){$.ajax({type:"GET",url:"/api/"+e()+"/getoldnotes?",dataType:"json",data:{subjects:t?t.toString():"",studentid:o},scriptCharset:"utf-8",success:function(t){var e=t.oldNotes;$("#notesbody tr").remove(),$.each(e,function(){$("#notesbody").append("<tr><td>"+this.date+"</td><td>"+this.subjects+'</td><td><span class="js-context">'+this.note+"</span></td></tr>")})}})}function n(t,o){$.ajax({type:"GET",url:"/api/"+e()+"/gettextbooks?",dataType:"json",data:{subjects:t?t.toString():"",grade:o},scriptCharset:"utf-8",success:function(t){for(var e=[],o=$("#subjects").val(),a=1;a<=i;a++){var n=$("#selTextbook"+a+" option:selected").text().split(":")[0],s=!1;if(""!==n){for(var r=0;r<o.length;r++)n===o[r]&&(s=!0);s===!0&&(e[a]={Textbook:$("#selTextbook"+a).val(),Unit:$("#selUnit"+a).val(),Page:$("#page"+a).val()})}}for(a=1;a<=l;a++)$("#selTextbook"+a).empty().change(),$("#selUnit"+a).empty(),$("#page"+a).val(""),$("#selTextbook"+a).append("<option></option>"),$("#selUnit"+a).append("<option></option>");$.each(t.textbooks,function(t,o){for(var a=1;a<=l;a++)$("#selTextbook"+a).append("<option value="+o.textbook.id+">"+o.textbook.subject+":"+o.textbook.name+"</option>");for($("[id^=selTextbook]").change(function(){var t=$("[id^=selTextbook]").index(this)+1,e="#selTextbook"+t+" option:selected",a=o.textbook.subject+":"+o.textbook.name;$(e).text()===a?($("#selUnit"+t).empty(),$("#selUnit"+t).append("<option></option>"),$.each(o.units,function(e,o){$("#selUnit"+t).append("<option value="+o.id+" >"+o.name+"</option>")})):""===$(e).text()&&($("#selUnit"+t).empty(),$("#selUnit"+t).append("<option></option>"))}),a=1;a<=l;a++)e[a]&&($("#selTextbook"+a).val(e[a].Textbook).change(),$("#selUnit"+a).val(e[a].Unit),$("#page"+a).val(e[a].Page))}),1===parseInt(status)&&$("#indicate-textbook").prop("checked",!0).change()}})}$.extend($.fn.pickadate.defaults,{monthsFull:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],monthsShort:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],weekdaysFull:["日曜日","月曜日","火曜日","水曜日","木曜日","金曜日","土曜日"],weekdaysShort:["日","月","火","水","木","金","土"],today:"今日",clear:"消去",firstDay:1,format:"yyyy mm dd",formatSubmit:"yyyy/mm/dd"}),$("#date-start").pickadate({format:"yyyy-mm-dd",formatSubmit:"yyyy-mm-dd",close:"閉じる",onOpen:function(){var t=$("#date-end").val();this.set("max",t&&t.length>0?new Date(t):"")}}),$("#date-end").pickadate({format:"yyyy-mm-dd",formatSubmit:"yyyy-mm-dd",close:"閉じる",onOpen:function(){var t=$("#date-start").val();this.set("min",t&&t.length>0?new Date(t):"")}}),$("#subjects").length>0&&$("#subjects").select2(),$("button[name=delete]").on("click",function(){return!!confirm("本当に削除してよろしいですか？")}),$("#status").on("change",function(){var t=$(this).val(),e=$("button[name=save]");"published"===t?e.html("保存して送信する"):e.html("保存する")});var s=0;$("#template").on("change",function(){if(!confirm("授業内容と宿題の書き換えが発生します。よろしいですか？"))return $(this).val(s),!1;var t=$("#template option:selected").val(),e="/api/"+$(this).siblings("input[name=school_slug]").val()+"/report/template/get/"+t,o="",a="",n="OK";return"0"!==t&&$.ajax({url:e,type:"GET",dataType:"json",data:{report_template_id:t},timeout:1e4,async:!1,success:function(t){o=t.lesson_text,a=t.homework_text},error:function(t){console.log(t.statusText),n="NG"}}),"NG"===n?($(this).val(s),$("#toast-message").stop().fadeOut(100,function(){$("#toast-message p").html("エラーが発生しました"),$("#toast-message").fadeIn(500).delay(2e3).fadeOut(500)}),!1):($("#lesson-text").val(o),$("#homework-text").val(a),void(s=nid))});var i=1,l=6;$("#indicate-textbook").on("change",function(){var e=$(this).prop("checked");if(e)$("#form-textbook").show(),t();else{$("#form-textbook").hide();for(var o=1;o<=l;o++)$("#selTextbook"+o).val(""),$("#selUnit"+o).val(""),$("#page"+o).val("");for(o=2;o<=l;o++)$("#Textbook"+o).hide();i=1,$(".plus").prop("disabled",!1),$(".minus").prop("disabled",!0)}}),$("#oldhomework").on("change",function(){var t=$("#subjects").val(),e=$(".report-profile-name").find("a:first").attr("href").split("/")[3];$("#oldhomework:checked").val()?(o(t,e),$("#homeworktable").show()):$("#homeworktable").hide()}),$("#oldnote").on("change",function(){var t=$("#subjects").val(),e=$(".report-profile-name").find("a:first").attr("href").split("/")[3];$("#oldnote:checked").val()?(a(t,e),$("#notetable").show()):$("#notetable").hide()}),$("#subjects").change(function(){if($("#subjects").val()&&$("#grade").val())n($("#subjects").val(),$("#grade").val());else for(var t=1;t<=l;t++)$("#selTextbook"+t).empty(),$("#selUnit"+t).empty(),$("#selTextbook"+t).append("<option></option>"),$("#selUnit"+t).append("<option></option>");var e=$("#subjects").val(),a=$(".report-profile-name").find("a:first").attr("href").split("/")[3];o(e,a)}),$(function(){n($("#subjects").val(),$("#grade").val())}),$(".plus").click(function(){var t=$('[id^="Textbook"]');t.each(function(t){var e=$(this).find('[id^="selTextbook"]').eq(0),o=e.val();$.isNumeric(o)&&(i=t+2)}),i>=l&&$(".plus").prop("disabled",!0),$("#Textbook"+i).show(),i>1&&$(".minus").prop("disabled",!1)}),$(".minus").click(function(){var t=i;i--;for(var e=$(".minus").index(this)+1,o=e;o<t;o++){var a=o+1,n=$("#selTextbook"+a).val(),s=$("#selUnit"+a).val(),l=$("#page"+a).val();$("#selTextbook"+o).val(n).change(),$("#selUnit"+o).val(s),$("#page"+o).val(l)}$("#selTextbook"+t).val(""),$("#selUnit"+t).val(""),$("#page"+t).val(""),$("#Textbook"+t).hide(),$(".plus").prop("disabled",!1),1===i&&$(".minus").prop("disabled",!0)}),$("[id^=Textbook]").change(function(){});var r=["#lesson-text","#homework-text","#comment","#note"];$(document).ready(function(){for(var t=0;t<4;t++)$(r[t]).trigger("input")}),$("#lesson-text, #homework-text, #comment, #note").on("input",function(t){if(t.target.scrollHeight>t.target.offsetHeight)$(t.target).height(t.target.scrollHeight);else for(var e=Number($(t.target).css("lineHeight").split("px")[0]);t.target.scrollHeight>80;)if($(t.target).height($(t.target).height()-e),t.target.scrollHeight>t.target.offsetHeight){$(t.target).height(t.target.scrollHeight);break}})});