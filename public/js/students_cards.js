$(function(){"use strict";function a(n,t,e,s){var d=e.parent("td"),i=d.children("span");0===s?setTimeout(function(){a(n,t,e,s+1)},3e3):s<=5?$.getJSON("/api/"+t+"/touch/check-handshaked/"+n,function(c){c.is_handshaked?(i.html(c.card_id),d.find(".card-release-button").css("display","inline"),$(".card-handshaking-button, .card-release-button, .card-checking-button").removeClass("btn-disabled")):setTimeout(function(){a(n,t,e,s+1)},3e3)}):(i.html(""),d.children(".card-handshaking-button").css("display","inline"),$(".card-handshaking-button, .card-release-button, .card-checking-button").removeClass("btn-disabled"))}function n(a,t,e){var s=t.parent("div"),d=s.children("p");0===e?setTimeout(function(){n(a,t,e+1)},3e3):e<=5?$.getJSON("/api/"+a+"/touch/check-card-id",function(s){s.is_checked?(d.html(s.card_id+" ("+(s.student_id?'<a href="'+s.student_id+'">'+s.name+"</a>":"未登録")+")"),$(".card-handshaking-button, .card-release-button, .card-checking-button").removeClass("btn-disabled")):setTimeout(function(){n(a,t,e+1)},3e3)}):(d.html(""),$(".card-handshaking-button, .card-release-button, .card-checking-button").removeClass("btn-disabled"))}$(".card-handshaking-button").on("click",function(){var n=$(this);if(n.hasClass("btn-disabled"))return!1;var t=n.parent("td"),e=t.children("span"),s=n.data("student_id"),d=n.data("slug"),i=n.data("message");return $.getJSON("/api/"+d+"/touch/start-handshake/"+s,function(t){t.started&&(n.css("display","none"),$(".card-handshaking-button, .card-release-button, .card-checking-button").addClass("btn-disabled"),"short"===i?e.html('<i class="fa fa-spin fa-spinner"></i> 15秒以内にタッチ...'):e.html('<i class="fa fa-spin fa-spinner"></i> 15秒以内に未登録のカードをタッチしてください。<br>Comiru Touchのランプが緑色に光り、ここにカードIDが表示されれば登録成功です。'),a(s,d,n,0))}),!1}),$(".card-release-button").on("click",function(){return!$(this).hasClass("btn-disabled")&&!!confirm("カードIDの設定を解除してよろしいですか？")}),$(".card-checking-button").on("click",function(){var a=$(this);if(a.hasClass("btn-disabled"))return!1;var t=a.parent("div"),e=t.children("p"),s=a.data("slug");return $.getJSON("/api/"+s+"/touch/start-checking-card-id",function(t){t.started&&(a.addClass("btn-disabled"),$(".card-handshaking-button, .card-release-button, .card-checking-button").addClass("btn-disabled"),e.html('<i class="fa fa-spin fa-spinner"></i> 15秒以内にカードを1度だけタッチしてください。<br>Comiru Touchのランプが緑色に光り、ここにカードIDが表示されます。<br>※15秒を経過した後にカードをタッチすると、入退室の記録・通知が発生することがありますので、ご注意ください。'),n(s,a,0))}),!1})});